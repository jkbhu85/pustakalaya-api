<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Pustakalaya | Use Case | Book Returned</title>
    <link type="text/css" rel="stylesheet" href="../css/pustakalaya.css" />
</head>

<body>
    <header id="header"></header>
    <nav></nav>

    <div class="main-content">
        <noscript>
            This website does not work without JavaScript. Please enable JavaScript or use a
            browser that supports JavaScript.
        </noscript>

        <div class="back-button">
            <a href="./toc-uses-cases.html">Back</a>
        </div>

        <h1>Book returned by user</h1>

        <h3>Terminology</h3>
        <table class="ptk-table-simple mb-2">
            <tbody>
                <tr>
                    <td>User</td>
                    <td>User to collect book from.</td>
                </tr>
                <tr>
                    <td>Book instance</td>
                    <td>The book instance to be returned or informed as misplaced by user</td>
                </tr>
                <tr>
                    <td>Requester</td>
                    <td>A user of the system having priviledge LIBRARIAN or above.</td>
                </tr>
            </tbody>
        </table>

        <h3>API Endpoint</h3>
        <table class="ptk-table-simple mb-2">
            <tbody>
                <tr>
                    <td>URI</td>
                    <td>
                        <code class="url">ptk/book/instance/returned</code>
                    </td>
                </tr>
                <tr>
                    <td>Http Method</td>
                    <td>POST</td>
                </tr>
            </tbody>
        </table>


        <h3>Required</h3>
        <div class="ptk-table-wrapper">
            <table class="ptk-table full-width table-valign-top">
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Data&nbsp;type</th>
                        <th>Description</th>
                        <th>Validation constraints</th>
                        <th>Error codes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>bookInstanceId</td>
                        <td>string</td>
                        <td>Required</td>
                        <td>Valid book instance id defined in the system.</td>
                        <td>
                            <table class="ptk-table-simple table-valign-top">
                                <thead>
                                    <tr>
                                        <th>Error&nbsp;code</th>
                                        <th>Condition</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>63</td>
                                        <td>book instance id does not exist</td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3>Precondition</h3>
        <ul>
            <li>Requester is authenticated.</li>
            <li>Requester must have priviledge of LIBRARIAN or above.</li>
            <li>The book instance is issued to a user.</li>
        </ul>

        <h3>Success scenario</h3>
        <ol>
            <li>
                <p>
                    Fetch the most recent entry in the <code>BookAssignmentHistory</code>
                    table with <code>book_instance_fk</code> column having value same as
                    <code>bookInstanceId</code> and update the following fields.
                </p>
                <ul>
                    <li>primary key of the requester in column <code>released_by_fk</code></li>
                    <li>current timestamp to mark the time of returned in column <code>return_date</code></li>
                    <li>amount fined in column <code>amount_fined</code></li>
                    <li>currency in column <code>currency_fk</code></li>
                </ul>
            </li>
            <li>The book quota count of user is decremented by 1.</li>
            <li>The book instance status is changed to <code>available</code>.</li>
        </ol>

        <div class="note mb-2">
            <p>To calculate the amount fined use the specified values as will be agreed in the
                below form.</p>
            <pre>period1 multiplier1 period2 multiplier2 ... periodN multiplierN 0 multiplier</pre>
            <p>Where <code>period1</code> will be number of days after expected retuen date of
                book and so on and <code>0</code> indicates the rest of the days. The number of
                days will be multiplied by corressponding multiplier as show below.</p>
<pre>
amount fined = period1 * multiplier1 
             + period2 * multiplier2
             + ... 
             + periodN * multiplierN 
             + &lt;rest_of_the_days&gt; * multiplier</pre>
            <p>For example:</p>
            <pre>30 1 30 1.5 0 2</pre>
            <p>After the expected return date the first 30 days will be fined with 1 unit of
                currency then next 30 days will be fined with 1.5 units of currency and rest of the
                next days will be fined with 2 units of currency.</p>
            <p>If a person has delayed a book by 65 days then the fined amount will be calculated as:</p>
            <pre>30 * 1 + 30 * 1.5 + 5 * 2 = 85 (Units of currency)</pre>
        </div>

        <h3>Failure scenario</h3>
        <ul>
            <li>
                <p>Requester is not authenticated.</p>
                <ul>
                    <li>Do nothing.</li>
                </ul>
            </li>
            <li>
                <p>Requester is not authorized.</p>
                <ul>
                    <li>Do nothing.</li>
                </ul>
            </li>
            <li>
                <p>Data is invalid.</p>
                <ul>
                    <li>Do nothing.</li>
                </ul>
            </li>
            <li>
                <p>Any other error.</p>
                <ul>
                    <li>Rollback any changes made to storage system.</li>
                </ul>
            </li>
        </ul>

        <h3>Response</h3>
        <p>
            The cases for which a response is not shown, the response is to be shown from
            <a href="../common-responses.html">common responses</a>.
        </p>

        <dl class="response-list">
            <dt>Book was returned successfully.</dt>
            <dd>
                <div class="response">
                    <div class="response-code">
                        <span>200</span>
                    </div>
                    <div class="response-message">
                        <code>&lt;empty_response&gt;</code>
                    </div>
                </div>
            </dd>

            <dt>Requester is not authenticated.</dt>
            <dd></dd>

            <dt>Requester is not authorized.</dt>
            <dd></dd>

            <dt>Data is invalid.</dt>
            <dd></dd>

            <dt>Any other error</dt>
            <dd></dd>
        </dl>
        <hr />

        <div class="back-button">
            <a href="./toc-uses-cases.html">Back</a>
        </div>
    </div>

    <footer id="footer"></footer>
    <script src="../js/global.js"></script>
</body>

</html>